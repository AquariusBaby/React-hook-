# 运输层

 - 负责两个主机中**进程之间的通信**提供服务
 - 由于一个主机可同时运行多个进程，因此运输层有**复用**和**分用**的功能（快递收发站）
 - 主要有两个协议：**传输控制协议TCP**、**用户数据报协议UDP**
 - 端口：给应用层进程的**标识**

---

#### UDP 用户数据报协议

1. 面向无连接的：在传送数据之前**不需要先建立连接**，终点主机收到UDP报文后也不需要给出任何确认，也没有连接可释放；
2. 尽最大努力交付（不保证可靠交付）：因此主机不需要维护复杂的连接状态表；
3. 面向报文的：UDP一次交付一个完整的报文（不拆分）；
4. 没有拥塞控制：因此网络出现拥塞不会使源主机的发送速率降低；（适合实时应用：IP电话、实时视频会议等）
5. 支持一对一、一对多、多对一、多对多的交互通信；
6. 首部开销小：只有8个字节（TCP有20个字节）；
7. 使用UDP协议的应用：文件传送、路由选择协议、IP地址配置；

**UDP首部格式：源端口 + 目的端口 + 长度 + 检验和** （各占2字节）

---

#### TCP 传输控制协议

1. 面向连接的：在传送数据之前必须先建立连接（三次握手），数据传送结束后要释放连接（四次分手）；
2. 提供可靠交付：通过TCP传送的数据，**无差错、不丢失、不重复、并且按序到达**；
3. 面向字节流的
4. 拥塞控制
5. 点对点的（一对一）交互通信
6. 全双工通信
7. 建立连接（三次握手）
8. 连接释放（四次分手）
9. 流量控制
10. 使用TCP协议的应用：电子邮件、万维网、文件传送、远程终端接入

##### 可靠交付服务

##### 面向字节流

TCP 中的**流**(stream)指的是**流入到进程或从进程流出的字节序列**；
面向字节流的含义是：虽然应用程序和TCP的交互是一次一个数据块（大小不等），但TCP把应用程序叫下来的数据看成仅仅是一连串的**无数结构的字节流**。

##### 套接字

TCP连接的两个端点称为： 套接字（socket）

套接字 = IP：端口号

##### 全双工通信

> TCP允许通信双方的应用进程在任何时候都能发送数据。TCP链接的两端都设有**发送缓存**和**接收缓存**，用来临时存放双向通信的数据。

在发送时，应用程序在把数据传送给TCP的缓存后，就可以做自己的事了，而TCP在合适的时候把数据发送出去。
在接收时，TCP把收到的数据放入缓存，上层的应用程序会在合适的时候读取缓存中的数据。


##### 可靠传输的工作原理

> 理想的传输条件有两点：
> 1. 传输信道不产生差错
> 2. 不管发送方以多快的速度发送数据，接收方总是来得及处理收到的数据

**1. 停止等待协议**
就是没发送完一个分组就停止发送，等待对方确认。在收到对方确认后在发送下一个分组。只要超过一段时间没有收到确认，就认为刚才发送的分组丢失了，重传前面发送过的分组（超时重传）;

**注意三点：**
 1. 发送方发送完，要暂时保存已发送的分组的副本（为超时重传用）。只有在收到相应的确认才能清楚副本。
 2. 分组和确认分组必须进行编号。（这样才能明确哪一个发送的分组收到了确认，哪一个分组还没收到确认）。
 3. 超时重传的超时计时器的重传时间应该比**分组传输往返的平均时间更长一些**

**确认丢失** 和 **确认迟到：**

 1. 确认丢失：如果接收方返回的确认请求丢失，发送方依旧超时重传，此时接收方再次返回确认请求，并丢弃掉第二次重传的分组；
 2. 确认迟到：如果接收方返回的确认请求延迟了很久（第二次的超时重传都结束了，发送方也接收到重传后返回的确认信息），后面收到这个第一次的确认信息，不会做任何处理；

**停止等待协议效率太低，所以采用流水线传输来提高信道利用率，如采用连续ARQ协议**

**2. 连续ARQ协议**

发送方可以连续发送多个分组，不必没发完一个分组就停顿下来等待对方的确认。发送方维持一个**发送窗口**，没收到一个确认，就把发送窗口向前移动一个分组的位置。

接收方一般采用**累积确认**的方式，就是说接收方不必对收到的分组逐个发送确认，而是收到几个分组后，对按序到达的最后一个发送确认；

**3. 滑动窗口协议**

**4. TCP报文段的首部格式**
 - **源端口 和 目的端口**
 - **序号**：范围0~2^23-1，TCP是面向字节流的，在一个TCP连接中传送的字节流中的每一个字节都按序编号
 - **确认号**：是期望收到对方下一个报文段的第一个数据字节的序号
 - **确认ACK**（ACKnowlegment）：仅当 ACK=1 时确认号字段才有效。当 ACK=0 时，确认号无效。TCP规定，在建立连接后所有传送的报文段都必须把 ACK 置 1。
 - **同步SYN**（SYNchronization）：在连接建立时用来同步序号。当 SYN=1 而 ACK=0 时，表明这是一个连接请求报文段。对方若同意建立连接，则应在响应的报文段中是 SYN=1 和 ACK=1。因此，SYN 置为 1 就表示这是一个连接请求或连接接受报文。
 - **终止FIN**（FINis，意思是“完”、“终”）：用来释放一个连接。当 FIN=1 时，表明此报文段的发送方的数据已发送完毕，并要求释放连接。
 - **推送PSH**（PuSH）：当两个应用程序进行交互式的通信时，有时在一端的应用程序希望在键入一个命令后立即就能够收到对方的响应。在这种情况下，TCP 就可以使用推送(push)操作。这时，发送方 TCP 把 PSH 置 1，并立即创建一个报文段发送出去。接收方 TCP 收到 PSH=1 的报文段，就尽快地（即“推送”向前）交付给接收应用进程，而不再等到整个缓存都填满了后再向上交付。
 - **窗口**：窗口值[0, 2^16 - 1]之间的整数。窗口指的是发送本报文段的一方的**接收窗口**（而不是自己的发送窗口）。窗口值告诉对方：从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。总之，**窗口值作为接收方让发送方设置其发送窗口的依据**。


##### TCP可靠传输的实现

 1. 以字节为单位的滑动窗口：TCP滑动窗口一字节为单位

##### TCP的流量控制

 1. 利用滑动窗口实现流量控制：
 所谓流量控制，就是让发送方的发送速率不要太快，要让接收方来得及接收；

##### TCP的拥塞控制
 1. 几种拥塞控制方式

##### TCP的运输连接管理
 1. 连接建立-三次握手
 2. 连接释放-四次分手